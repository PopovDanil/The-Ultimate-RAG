<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .viewer-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .page-info {
            font-weight: bold;
        }
        #pdfViewer {
            width: 100%;
            min-height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .iframe-container {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .highlight-info {
            background: #e6f7ff;
            padding: 10px;
            border-left: 4px solid #1890ff;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Document Viewer</h1>
        <div class="viewer-container">
            <div class="navigation">
                <div class="nav-buttons">
                    <button id="prevBtn" onclick="navigatePage(-1)">Previous</button>
                    <button id="nextBtn" onclick="navigatePage(1)">Next</button>
                </div>
                <div class="page-info">Page: <span id="currentPage">{{ page }}</span> of <span id="totalPages">{{ total_pages }}</span></div>
                <div class="page-control">
                    <input type="number" id="pageInput" min="1" max="{{ total_pages }}" value="{{ page }}">
                    <button onclick="goToPage()">Go</button>
                </div>
            </div>
            
            {% if file_extension == '.pdf' %}
            <div id="pdfViewer"></div>
            {% else %}
            <div class="iframe-container">
                <iframe id="docFrame" src="/documents/{{ document_name }}"></iframe>
            </div>
            {% endif %}
            
            {% if start_line or end_line %}
            <div class="highlight-info">
                <strong>Highlighted Section:</strong>
                {% if start_line and end_line %}
                Lines {{ start_line }} to {{ end_line }}
                {% elif start_line %}
                Starting at line {{ start_line }}
                {% elif end_line %}
                Up to line {{ end_line }}
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    {% if file_extension == '.pdf' %}
    <script>
        // PDF.js configuration
        pdfjsLib.GlobalWorkerOptions.workerSrc = 
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js';
        
        // Initialize viewer
        let currentPage = {{ page }};
        const totalPages = {{ total_pages }};
        const pdfUrl = "{{ document_path }}";
        let pdfDoc = null;
        
        document.getElementById('currentPage').textContent = currentPage;
        document.getElementById('totalPages').textContent = totalPages;
        document.getElementById('pageInput').value = currentPage;
        
        // Load and render PDF
        pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
            pdfDoc = pdf;
            renderPage(currentPage);
        });
        
        function renderPage(pageNum) {
            pdfDoc.getPage(pageNum).then(function(page) {
                const scale = 1.5;
                const viewport = page.getViewport({ scale: scale });
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);
                
                renderTask.promise.then(function() {
                    // Clear previous content
                    const viewer = document.getElementById('pdfViewer');
                    viewer.innerHTML = '';
                    viewer.appendChild(canvas);
                });
            });
            
            // Update UI
            document.getElementById('currentPage').textContent = pageNum;
            document.getElementById('pageInput').value = pageNum;
            document.getElementById('prevBtn').disabled = (pageNum <= 1);
            document.getElementById('nextBtn').disabled = (pageNum >= totalPages);
            
            // Update URL without reloading
            const newUrl = `/see_document/name={{ document_name }}#page=${pageNum}`;
            window.history.replaceState(null, '', newUrl);
        }
        
        function navigatePage(offset) {
            const newPage = currentPage + offset;
            if (newPage > 0 && newPage <= totalPages) {
                currentPage = newPage;
                renderPage(currentPage);
            }
        }
        
        function goToPage() {
            const pageInput = document.getElementById('pageInput');
            const newPage = parseInt(pageInput.value);
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderPage(currentPage);
            } else {
                pageInput.value = currentPage;
            }
        }
        
        // Handle deep link on initial load
        window.onload = function() {
            // Highlighting logic could be added here for PDFs
        };
    </script>
    {% else %}
    <script>
        // For non-PDF documents
        let currentPage = {{ page }};
        const totalPages = {{ total_pages }};
        
        function navigatePage(offset) {
            const newPage = currentPage + offset;
            if (newPage > 0 && newPage <= totalPages) {
                currentPage = newPage;
                updatePage();
            }
        }
        
        function goToPage() {
            const pageInput = document.getElementById('pageInput');
            const newPage = parseInt(pageInput.value);
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                updatePage();
            } else {
                pageInput.value = currentPage;
            }
        }
        
        function updatePage() {
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('pageInput').value = currentPage;
            document.getElementById('prevBtn').disabled = (currentPage <= 1);
            document.getElementById('nextBtn').disabled = (currentPage >= totalPages);
            
            // Update URL
            const newUrl = `/see_document/name={{ document_name }}#page=${currentPage}`;
            window.history.replaceState(null, '', newUrl);
            
            // Note: Page navigation in non-PDF documents is limited
            // This would require more advanced handling based on document type
        }
    </script>
    {% endif %}
</body>
</html>